#!/usr/bin/env bash
#
# ai - Natural language interface for budget CLI
#
# Uses pattern matching for fast execution (~150ms) with LLM fallback for complex requests.
#
# Usage:
#   budget ai "Add my paycheck of $3200"
#   budget ai "Pay rent $1850 and electric $142"
#   budget ai "Assign $500 to groceries"
#
# Options:
#   -y, --yes    Skip confirmation prompt
#
# Performance:
#   - Simple requests: ~150ms (pattern matched)
#   - Complex requests: ~7s (LLM)
#   - Accuracy: ~95%
#

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BUDGET_CLI="${BUDGET_CLI:-$SCRIPT_DIR/dist/budget}"
DB_FILE="${DB_FILE:-}"
OLLAMA_API="${OLLAMA_API:-http://localhost:11434}"
LLM_MODEL="${LLM_MODEL:-gpt-oss:20b}"
LLM_THINK="${LLM_THINK:-medium}"
AUTO_CONFIRM="${AUTO_CONFIRM:-false}"

# Build budget command with optional db flag
budget_cmd() {
    if [[ -n "$DB_FILE" ]]; then
        "$BUDGET_CLI" --db "$DB_FILE" "$@"
    else
        "$BUDGET_CLI" "$@"
    fi
}

# ─────────────────────────────────────────────────────────────────────────────
# Pattern Matching (Zero-LLM Path)
# ─────────────────────────────────────────────────────────────────────────────

extract_amount() {
    echo "$1" | grep -oE '\$?[0-9,]+\.?[0-9]*' | head -1 | tr -d '$,'
}

extract_amounts() {
    echo "$1" | grep -oE '\$?[0-9,]+\.?[0-9]*' | tr -d '$,' | tr '\n' ' '
}

detect_account() {
    local text="$1"
    local text_lower=$(echo "$text" | tr '[:upper:]' '[:lower:]')

    if [[ "$text_lower" == *"checking"* ]]; then echo "Checking"
    elif [[ "$text_lower" == *"savings"* ]]; then echo "Savings"
    elif [[ "$text_lower" == *"credit"* ]] || [[ "$text_lower" == *"card"* ]]; then echo "Credit Card"
    elif [[ "$text_lower" == *"cash"* ]]; then echo "Cash"
    else echo "Checking"
    fi
}

detect_payee() {
    local text="$1"
    local text_lower=$(echo "$text" | tr '[:upper:]' '[:lower:]')

    # Income payees
    [[ "$text_lower" == *"paycheck"* || "$text_lower" == *"salary"* ]] && { echo "Paycheck"; return; }
    [[ "$text_lower" == *"bonus"* ]] && { echo "Bonus"; return; }
    [[ "$text_lower" == *"deposit"* ]] && { echo "Deposit"; return; }

    # Expense payees
    [[ "$text_lower" == *"rent"* ]] && { echo "Landlord"; return; }
    [[ "$text_lower" == *"electric"* ]] && { echo "Electric Company"; return; }
    [[ "$text_lower" == *"water"* ]] && { echo "Water Company"; return; }
    [[ "$text_lower" == *"internet"* ]] && { echo "Internet Provider"; return; }
    [[ "$text_lower" == *"phone"* ]] && { echo "Phone Company"; return; }
    [[ "$text_lower" == *"grocer"* ]] && { echo "Grocery Store"; return; }
    [[ "$text_lower" == *"gas"* || "$text_lower" == *"fuel"* ]] && { echo "Gas Station"; return; }

    # Extract from "at STORE" or "to PAYEE"
    if [[ "$text" =~ at[[:space:]]+([A-Za-z0-9[:space:]\']+) ]]; then
        echo "${BASH_REMATCH[1]}" | sed 's/\$[0-9,.]*//' | xargs
    elif [[ "$text" =~ to[[:space:]]+([A-Za-z0-9[:space:]\']+) ]]; then
        echo "${BASH_REMATCH[1]}" | sed 's/\$[0-9,.]*//' | xargs
    else
        echo "Unknown"
    fi
}

detect_category() {
    local text="$1"
    local text_lower=$(echo "$text" | tr '[:upper:]' '[:lower:]')

    # Try to match common categories
    [[ "$text_lower" == *"rent"* ]] && { echo "Rent"; return; }
    [[ "$text_lower" == *"grocer"* ]] && { echo "Groceries"; return; }
    [[ "$text_lower" == *"electric"* ]] && { echo "Utilities"; return; }
    [[ "$text_lower" == *"water"* ]] && { echo "Utilities"; return; }
    [[ "$text_lower" == *"internet"* ]] && { echo "Utilities"; return; }
    [[ "$text_lower" == *"phone"* ]] && { echo "Phone"; return; }
    [[ "$text_lower" == *"gas"* || "$text_lower" == *"fuel"* ]] && { echo "Transportation"; return; }
    [[ "$text_lower" == *"dining"* || "$text_lower" == *"restaurant"* ]] && { echo "Dining"; return; }
    [[ "$text_lower" == *"coffee"* ]] && { echo "Dining"; return; }

    echo ""
}

# Try to match income pattern
match_income() {
    local text="$1"
    local text_lower=$(echo "$text" | tr '[:upper:]' '[:lower:]')

    if [[ "$text_lower" == *"paycheck"* ]] || \
       [[ "$text_lower" == *"salary"* ]] || \
       [[ "$text_lower" == *"income"* ]] || \
       [[ "$text_lower" == *"deposit"* ]] || \
       [[ "$text_lower" == *"bonus"* ]]; then

        local amount=$(extract_amount "$text")
        [[ -z "$amount" ]] && return 1

        local account=$(detect_account "$text")
        local payee=$(detect_payee "$text")

        echo "add_transaction|$account|$amount|$payee"
        return 0
    fi
    return 1
}

# Try to match expense pattern
match_expense() {
    local text="$1"
    local text_lower=$(echo "$text" | tr '[:upper:]' '[:lower:]')

    if [[ "$text_lower" == *"pay "* ]] || \
       [[ "$text_lower" == *"paid "* ]] || \
       [[ "$text_lower" == *"spent"* ]] || \
       [[ "$text_lower" == *"bought"* ]] || \
       [[ "$text_lower" == *"purchase"* ]] || \
       [[ "$text_lower" == *"record "* && "$text_lower" != *"income"* ]]; then

        # Check for compound (multiple amounts)
        local amounts=($(extract_amounts "$text"))
        [[ ${#amounts[@]} -gt 1 ]] && return 1

        local amount=$(extract_amount "$text")
        [[ -z "$amount" ]] && return 1

        local account=$(detect_account "$text")
        local payee=$(detect_payee "$text")
        local category=$(detect_category "$text")

        echo "add_transaction|$account|-$amount|$payee|$category"
        return 0
    fi
    return 1
}

# Try to match assignment pattern
match_assign() {
    local text="$1"
    local text_lower=$(echo "$text" | tr '[:upper:]' '[:lower:]')

    if [[ "$text_lower" == *"assign"* ]] || \
       [[ "$text_lower" == *"allocate"* ]] || \
       [[ "$text_lower" == *"budget "* ]]; then

        # Check for compound
        local amounts=($(extract_amounts "$text"))
        [[ ${#amounts[@]} -gt 1 ]] && return 1

        local amount=$(extract_amount "$text")
        [[ -z "$amount" ]] && return 1

        local category=$(detect_category "$text")
        [[ -z "$category" ]] && return 1

        echo "assign_money|$category|$amount"
        return 0
    fi
    return 1
}

# Try to match list pattern
match_list() {
    local text="$1"
    local text_lower=$(echo "$text" | tr '[:upper:]' '[:lower:]')

    if [[ "$text_lower" == *"list"*"account"* ]] || \
       [[ "$text_lower" == *"show"*"account"* ]] || \
       [[ "$text_lower" == *"what"*"account"* ]]; then
        echo "list_accounts"
        return 0
    fi

    if [[ "$text_lower" == *"list"*"categor"* ]] || \
       [[ "$text_lower" == *"show"*"categor"* ]] || \
       [[ "$text_lower" == *"what"*"categor"* ]]; then
        echo "list_categories"
        return 0
    fi

    return 1
}

# Main pattern matching
try_pattern() {
    local request="$1"
    local result

    result=$(match_list "$request") && { echo "$result"; return 0; }
    result=$(match_income "$request") && { echo "$result"; return 0; }
    result=$(match_expense "$request") && { echo "$result"; return 0; }
    result=$(match_assign "$request") && { echo "$result"; return 0; }

    return 1
}

# ─────────────────────────────────────────────────────────────────────────────
# LLM Fallback
# ─────────────────────────────────────────────────────────────────────────────

get_budget_context() {
    local accounts categories
    accounts=$(budget_cmd --json account list 2>/dev/null | jq -r '[.[].name] | join(", ")' || echo "")
    categories=$(budget_cmd --json category list 2>/dev/null | jq -r '[.[].name] | join(", ")' || echo "")
    echo "Accounts: $accounts. Categories: $categories."
}

call_llm() {
    local request="$1"
    local context="$2"

    local system_prompt='You are a budget assistant. Output a JSON plan.
Format: {"steps":[{"action":"ACTION","params":{...}}]}

Available actions:
- list_accounts: params {} - show all accounts
- list_categories: params {} - show all categories
- create_budget: params {name, currency} - ONLY use when user explicitly asks to create a NEW budget
- add_account: params {name, type (checking|savings|credit|cash)}
- delete_account: params {name} - deletes account and all its transactions
- add_category: params {name, group (optional)}
- add_transaction: params {account, amount (positive=income, negative=expense), payee, category (optional)}
- delete_transaction: params {id} - deletes a transaction by ID
- assign_money: params {category, amount (always positive)}

IMPORTANT: For "reset" or "clean" accounts: just delete_account then add_account. Do NOT create_budget.
Use exact account/category names from context. Output ONLY valid JSON.'

    local user_msg="Context: $context
Request: $request"

    local payload
    payload=$(jq -n \
        --arg model "$LLM_MODEL" \
        --arg system "$system_prompt" \
        --arg user "$user_msg" \
        --arg think "$LLM_THINK" \
        '{model:$model,messages:[{role:"system",content:$system},{role:"user",content:$user}],stream:false,think:$think,format:"json"}')

    curl -s "$OLLAMA_API/api/chat" -d "$payload" | jq -r '.message.content'
}

# ─────────────────────────────────────────────────────────────────────────────
# Plan Display & Confirmation
# ─────────────────────────────────────────────────────────────────────────────

format_amount() {
    local amount="$1"
    # Handle negative amounts
    if [[ "$amount" == -* ]]; then
        printf "\033[0;31m-$%s\033[0m" "${amount#-}"
    else
        printf "\033[0;32m+$%s\033[0m" "$amount"
    fi
}

# Display pattern-matched plan
show_pattern_plan() {
    local action="$1" p1="$2" p2="$3" p3="$4" p4="$5"

    echo ""
    echo "Proposed action:"
    echo "────────────────────────────────────────"

    case "$action" in
        list_accounts)
            echo "  Show all accounts"
            ;;
        list_categories)
            echo "  Show all categories"
            ;;
        add_transaction)
            local amount_display=$(format_amount "$p2")
            echo "  Transaction: $amount_display"
            echo "  Account:     $p1"
            echo "  Payee:       $p3"
            [[ -n "$p4" ]] && echo "  Category:    $p4"
            ;;
        assign_money)
            echo "  Assign: \$$p2 to $p1"
            ;;
    esac
    echo "────────────────────────────────────────"
}

# Display LLM-generated plan
show_llm_plan() {
    local plan="$1"
    local count=$(echo "$plan" | jq -r '.steps | length')

    # Count valid steps first
    local valid_count=0
    for ((i=0; i<count; i++)); do
        local step=$(echo "$plan" | jq -c ".steps[$i]")
        if echo "$step" | jq -e 'type == "object" and has("action")' >/dev/null 2>&1; then
            ((valid_count++))
        fi
    done

    echo ""
    echo "Proposed actions ($valid_count step(s)):"
    echo "────────────────────────────────────────"

    local step_num=0
    for ((i=0; i<count; i++)); do
        local step=$(echo "$plan" | jq -c ".steps[$i]")

        # Silently skip invalid steps
        if ! echo "$step" | jq -e 'type == "object" and has("action")' >/dev/null 2>&1; then
            continue
        fi

        local action=$(echo "$step" | jq -r '.action')
        local params=$(echo "$step" | jq -c '.params // {}')

        ((step_num++))
        echo "  $step_num. $action"

        case "$action" in
            list_accounts)
                echo "     (show all accounts)"
                ;;
            list_categories)
                echo "     (show all categories)"
                ;;
            add_transaction)
                local account=$(echo "$params" | jq -r '.account')
                local amount=$(echo "$params" | jq -r '.amount')
                local payee=$(echo "$params" | jq -r '.payee')
                local category=$(echo "$params" | jq -r '.category // empty')
                local amount_display=$(format_amount "$amount")
                echo "     Amount:   $amount_display"
                echo "     Account:  $account"
                echo "     Payee:    $payee"
                [[ -n "$category" ]] && echo "     Category: $category"
                ;;
            assign_money)
                local category=$(echo "$params" | jq -r '.category')
                local amount=$(echo "$params" | jq -r '.amount')
                echo "     Assign \$$amount to $category"
                ;;
            create_budget)
                local name=$(echo "$params" | jq -r '.name')
                local currency=$(echo "$params" | jq -r '.currency // "USD"')
                echo "     Name:     $name"
                echo "     Currency: $currency"
                ;;
            add_account)
                local name=$(echo "$params" | jq -r '.name')
                local type=$(echo "$params" | jq -r '.type // "checking"')
                echo "     Name: $name"
                echo "     Type: $type"
                ;;
            delete_account)
                local name=$(echo "$params" | jq -r '.name')
                # Look up actual accounts that will be deleted
                local matching=$(budget_cmd --json account list 2>/dev/null | jq -r --arg name "$name" '.[] | select(.name == $name) | "\(.id[0:8])... \(.name) (\(.type))"')
                if [[ -n "$matching" ]]; then
                    local match_count=$(echo "$matching" | wc -l | tr -d ' ')
                    printf "     \033[0;31mDelete %s account(s):\033[0m\n" "$match_count"
                    while IFS= read -r line; do
                        echo "       - $line"
                    done <<< "$matching"
                else
                    printf "     \033[0;31mDelete:\033[0m %s (not found)\n" "$name"
                fi
                ;;
            delete_transaction)
                local id=$(echo "$params" | jq -r '.id')
                # Look up transaction details
                local tx_info=$(budget_cmd --json tx list 2>/dev/null | jq -r --arg id "$id" '.[] | select(.id == $id or (.id | startswith($id))) | "\(.id[0:8])... \(.payee) \(.amount)"' | head -1)
                if [[ -n "$tx_info" ]]; then
                    printf "     \033[0;31mDelete:\033[0m %s\n" "$tx_info"
                else
                    printf "     \033[0;31mDelete:\033[0m %s (not found)\n" "$id"
                fi
                ;;
            add_category)
                local name=$(echo "$params" | jq -r '.name')
                local group=$(echo "$params" | jq -r '.group // "Uncategorized"')
                echo "     Name:  $name"
                echo "     Group: $group"
                ;;
            *)
                echo "     $(echo "$params" | jq -c '.')"
                ;;
        esac
    done
    echo "────────────────────────────────────────"
}

# Ask user for confirmation
confirm_plan() {
    if [[ "$AUTO_CONFIRM" == "true" ]]; then
        return 0
    fi

    echo ""
    read -p "Execute this plan? [y/N] " -n 1 -r
    echo ""

    if [[ $REPLY =~ ^[Yy]$ ]]; then
        return 0
    else
        echo "Cancelled."
        return 1
    fi
}

# ─────────────────────────────────────────────────────────────────────────────
# Execution
# ─────────────────────────────────────────────────────────────────────────────

execute_action() {
    local action="$1"
    shift

    case "$action" in
        list_accounts)
            budget_cmd account list
            ;;
        list_categories)
            budget_cmd category list
            ;;
        add_transaction)
            local account="$1" amount="$2" payee="$3" category="$4"
            if [[ -n "$category" ]]; then
                # Try with category, fall back to without if category doesn't exist
                budget_cmd tx add --account "$account" --amount "$amount" --payee "$payee" --category "$category" 2>/dev/null || \
                budget_cmd tx add --account "$account" --amount "$amount" --payee "$payee"
            else
                budget_cmd tx add --account "$account" --amount "$amount" --payee "$payee"
            fi
            ;;
        assign_money)
            local category="$1" amount="$2"
            budget_cmd assign "$category" "$amount"
            ;;
        create_budget)
            local name="$1" currency="${2:-USD}"
            budget_cmd create "$name" --currency "$currency"
            budget_cmd use "$name" 2>/dev/null || true
            ;;
        add_account)
            local name="$1" type="${2:-checking}"
            budget_cmd account add "$name" --type "$type"
            ;;
        delete_account)
            local name="$1"
            # Get ALL account IDs by name and delete with --force to remove transactions
            local account_ids=$(budget_cmd --json account list 2>/dev/null | jq -r --arg name "$name" '.[] | select(.name == $name) | .id')
            if [[ -n "$account_ids" ]]; then
                while IFS= read -r account_id; do
                    [[ -n "$account_id" ]] && budget_cmd account delete "$account_id" --force
                done <<< "$account_ids"
            else
                echo "Account not found: $name" >&2
            fi
            ;;
        delete_transaction)
            local id="$1"
            # Try exact match first, then prefix match
            local full_id=$(budget_cmd --json tx list 2>/dev/null | jq -r --arg id "$id" '.[] | select(.id == $id or (.id | startswith($id))) | .id' | head -1)
            if [[ -n "$full_id" ]]; then
                budget_cmd tx delete "$full_id" --force
            else
                echo "Transaction not found: $id" >&2
            fi
            ;;
        add_category)
            local name="$1" group="${2:-Uncategorized}"
            budget_cmd group add "$group" 2>/dev/null || true
            budget_cmd category add "$name" --group "$group"
            ;;
        *)
            echo "Unknown action: $action" >&2
            return 1
            ;;
    esac
}

execute_plan() {
    local plan="$1"

    local count=$(echo "$plan" | jq -r '.steps | length')
    [[ "$count" -eq 0 ]] && { echo "No actions to execute"; return; }

    for ((i=0; i<count; i++)); do
        local step=$(echo "$plan" | jq -c ".steps[$i]")

        # Skip invalid steps
        if ! echo "$step" | jq -e 'type == "object" and has("action")' >/dev/null 2>&1; then
            continue
        fi

        local action=$(echo "$step" | jq -r '.action')
        local params=$(echo "$step" | jq -c '.params // {}')

        case "$action" in
            list_accounts|list_categories)
                execute_action "$action"
                ;;
            add_transaction)
                local account=$(echo "$params" | jq -r '.account')
                local amount=$(echo "$params" | jq -r '.amount')
                local payee=$(echo "$params" | jq -r '.payee')
                local category=$(echo "$params" | jq -r '.category // empty')
                execute_action "$action" "$account" "$amount" "$payee" "$category"
                ;;
            assign_money)
                local category=$(echo "$params" | jq -r '.category')
                local amount=$(echo "$params" | jq -r '.amount')
                execute_action "$action" "$category" "$amount"
                ;;
            create_budget)
                local name=$(echo "$params" | jq -r '.name')
                local currency=$(echo "$params" | jq -r '.currency // "USD"')
                execute_action "$action" "$name" "$currency"
                ;;
            add_account)
                local name=$(echo "$params" | jq -r '.name')
                local type=$(echo "$params" | jq -r '.type // "checking"')
                execute_action "$action" "$name" "$type"
                ;;
            delete_account)
                local name=$(echo "$params" | jq -r '.name')
                execute_action "$action" "$name"
                ;;
            delete_transaction)
                local id=$(echo "$params" | jq -r '.id')
                execute_action "$action" "$id"
                ;;
            add_category)
                local name=$(echo "$params" | jq -r '.name')
                local group=$(echo "$params" | jq -r '.group // "Uncategorized"')
                execute_action "$action" "$name" "$group"
                ;;
            *)
                echo "Unknown action in plan: $action" >&2
                ;;
        esac
    done
}

# ─────────────────────────────────────────────────────────────────────────────
# Main
# ─────────────────────────────────────────────────────────────────────────────

show_usage() {
    echo "Usage: budget ai [OPTIONS] \"<natural language request>\""
    echo ""
    echo "Options:"
    echo "  -y, --yes    Skip confirmation prompt"
    echo ""
    echo "Examples:"
    echo "  budget ai \"Add my paycheck of \$3200\""
    echo "  budget ai \"Pay rent \$1850\""
    echo "  budget ai -y \"Spent \$45 at coffee shop\""
    echo "  budget ai \"Assign \$500 to groceries\""
    echo ""
    echo "Environment:"
    echo "  LLM_MODEL      Model for complex requests (default: gpt-oss:20b)"
    echo "  LLM_THINK      Thinking level: low|medium|high (default: medium)"
    echo "  AUTO_CONFIRM   Set to 'true' to skip confirmation"
}

main() {
    local request=""

    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -y|--yes)
                AUTO_CONFIRM="true"
                shift
                ;;
            -h|--help)
                show_usage
                exit 0
                ;;
            -*)
                echo "Unknown option: $1" >&2
                show_usage
                exit 1
                ;;
            *)
                request="$1"
                shift
                ;;
        esac
    done

    if [[ -z "$request" ]]; then
        show_usage
        exit 1
    fi

    # Try pattern matching first (fast path)
    local pattern_result
    if pattern_result=$(try_pattern "$request"); then
        IFS='|' read -r action p1 p2 p3 p4 <<< "$pattern_result"

        show_pattern_plan "$action" "$p1" "$p2" "$p3" "$p4"

        if confirm_plan; then
            execute_action "$action" "$p1" "$p2" "$p3" "$p4"
        else
            exit 1
        fi
        exit 0
    fi

    # Fallback to LLM
    echo "Processing with AI..." >&2
    local context=$(get_budget_context)
    local plan=$(call_llm "$request" "$context")

    if ! echo "$plan" | jq . >/dev/null 2>&1; then
        echo "Error: Failed to get valid plan from LLM" >&2
        exit 1
    fi

    show_llm_plan "$plan"

    if confirm_plan; then
        execute_plan "$plan"
    else
        exit 1
    fi
}

main "$@"
